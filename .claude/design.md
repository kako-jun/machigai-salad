# 設計ドキュメント

## プロジェクト概要

「小エビの間違いサラダ」は、サイゼリヤの間違い探しをスマートフォンやブラウザで楽しく遊べるようにするWebアプリケーションです。

### ターゲットユーザー

- **子供**: 小学生でも使える平易な言葉とカラフルなUI
- **家族**: サイゼリヤで食事を楽しむ家族連れ
- **カジュアルユーザー**: 専門知識不要で直感的に使える

### コアバリュー

1. **完全無料**: サーバーコスト0円
2. **プライバシー保護**: 画像は端末内で処理、外部送信なし
3. **使いやすさ**: 子供でも迷わず使える
4. **楽しさ**: 絵文字とカラフルなデザイン

## アーキテクチャ

### システム構成

```
┌─────────────────────────────────────┐
│   ユーザーのブラウザ                  │
│                                     │
│  ┌──────────────────────────────┐  │
│  │  React 19 + Next.js 15       │  │
│  │  (静的サイト)                 │  │
│  └──────────────────────────────┘  │
│              ↓                      │
│  ┌──────────────────────────────┐  │
│  │  OpenCV.js                   │  │
│  │  (CDNからロード)              │  │
│  └──────────────────────────────┘  │
│              ↓                      │
│  ┌──────────────────────────────┐  │
│  │  カメラ / ファイル入力        │  │
│  └──────────────────────────────┘  │
└─────────────────────────────────────┘
```

### 画像処理パイプライン

```
カメラ撮影
    ↓
1. 紙の自動検出 (detectPaperContour)
   - グレースケール変換
   - ガウシアンブラー
   - Cannyエッジ検出（複数しきい値で試行）
   - 輪郭抽出
   - 4角形検出
    ↓
2. 角の調整UI (PaperCornersAdjustment)
   - 検出した4つの角を表示
   - ドラッグで微調整可能
   - タッチ/マウス操作対応
    ↓
3. 台形補正 (applyPerspectiveTransform)
   - 透視変換行列の計算
   - warpPerspectiveで画像変換
    ↓
4. 色調補正
   - ヒストグラム均等化
   - RGB各チャンネルごとに処理
    ↓
5. 左右分割
   - 中央で分割
   - 2つの画像を生成
    ↓
6. 比較表示 (ImageComparison)
   - タップで切り替え
   - スムーズなアニメーション
```

## コンポーネント設計

### 1. ImageProcessor (統合コンポーネント)

**役割**: アプリ全体の状態管理と画像処理フロー制御

**状態**:

```typescript
// 画像データ
originalImage: string | null          // 元画像
leftImage: string | null              // 分割後の左画像
rightImage: string | null             // 分割後の右画像

// UI状態
isProcessing: boolean                 // 処理中フラグ
cvLoaded: boolean                     // OpenCV.js読み込み完了
detectedCorners: Point[] | null       // 検出した4つの角
showCornersAdjustment: boolean        // 角調整UI表示フラグ
```

**主要メソッド**:

- `handleImageUpload()`: 画像アップロード処理
- `detectPaperCorners()`: 紙の4角を自動検出
- `handleCornersApply()`: 調整後の角で台形補正を実行
- `handleCornersCancel()`: 角調整をスキップ
- `processImageWithCorners()`: 台形補正〜分割までの処理

### 2. ImageUpload (画像入力UI)

**役割**: カメラ撮影またはファイル選択

**特徴**:

- `capture="environment"`: 背面カメラを優先
- 子供向けの大きなボタンとわかりやすい説明
- OpenCV.jsロード中はボタンを無効化

**デザイン**:

- 🍤 小エビのアイコン
- オレンジ〜イエローのグラデーション背景
- 4ステップの使い方ガイド

### 3. PaperCornersAdjustment (角調整UI)

**役割**: 自動検出した紙の角を微調整

**機能**:

- Canvasに画像と4つの角を描画
- ドラッグで角の位置を変更
- リアルタイムで描画を更新

**視覚デザイン**:

- オレンジ色の丸で角を表示
- ドラッグ中は光る（グロー効果）
- 方向矢印の絵文字（↖️↗️↘️↙️）
- 太い線で四角形を描画

**操作**:

- マウス/タッチ両対応
- 画像サイズに応じて自動スケール
- 画像境界外に出ないようクランプ

### 4. ImageComparison (画像比較UI)

**役割**: 左右の画像を切り替えて表示

**動作**:

- デフォルト: 左の画像を表示
- タッチダウン/マウスダウン: 右の画像を表示
- タッチアップ/マウスアップ: 左の画像に戻る
- マウスが領域外に出た場合も左に戻る

**デザイン**:

- 画像下部にインジケーター（1つ目/2つ目）
- スムーズなフェードアニメーション
- 操作ガイドを常に表示

## OpenCV.js活用

### 紙の自動検出アルゴリズム

```typescript
// 複数のCannyしきい値で試行
const thresholdPairs = [
  [30, 100], // 弱いエッジも検出
  [50, 150], // 標準
  [75, 200], // 強いエッジのみ
]

// 複数のepsilonで四角形近似
for (const epsilon of [0.02, 0.03, 0.04]) {
  cv.approxPolyDP(contour, approx, epsilon * peri, true)
  // 4つの角を持つ場合に採用
}
```

**検出条件**:

- 面積が画像の5%以上
- 4つの角を持つ多角形
- 最も大きい四角形を採用
- 20%以上の候補が見つかったら早期終了

### 台形補正 (透視変換)

```typescript
// 4つの角から変換行列を計算
const M = cv.getPerspectiveTransform(srcPoints, dstPoints)

// 画像を変換
cv.warpPerspective(src, warped, M, new cv.Size(maxWidth, maxHeight))
```

**幅・高さの計算**:

- 上辺と下辺の長さから最大幅を算出
- 左辺と右辺の長さから最大高さを算出
- 変換後は正面から見た長方形になる

### メモリ管理

OpenCV.jsのMatオブジェクトは必ず`.delete()`で解放:

```typescript
try {
  const src = cv.imread(canvas)
  const gray = new cv.Mat()
  // ... 処理 ...
} finally {
  src.delete()
  gray.delete()
  // 全てのMatを明示的に解放
}
```

## UIデザイン原則

### 子供向けデザイン

1. **平易な言葉**
   - 「紙の範囲を調整」→「📄 まっすぐに直そう！」
   - 「適用」→「これでOK！」
   - 専門用語を避ける

2. **絵文字を活用**
   - 🍤 小エビ（アプリのシンボル）
   - 📷 写真
   - 🎯 まちがいさがし
   - 💡 ヒント
   - ↖️↗️↘️↙️ 方向

3. **カラフルなデザイン**
   - オレンジ〜イエローのグラデーション
   - 明るく楽しい配色
   - 高コントラストで見やすく

4. **大きなボタン**
   - タッチしやすいサイズ
   - タップ時にアニメーション（`active:scale-95`）
   - 影付きで立体感

### アクセシビリティ

- タッチとマウス両対応
- スクリーンリーダー用のalt属性
- 十分なコントラスト比
- 大きなタップターゲット（48px以上）

## パフォーマンス最適化

### 画像処理の最適化

1. **早期終了**: 良い候補が見つかったら検索を打ち切り
2. **適応的パラメータ**: 複数の設定を試行して最適なものを選択
3. **非同期処理**: Promiseでラップしてメインスレッドをブロックしない

### ロード時間の最適化

1. **OpenCV.jsの遅延ロード**: 初回アクセス時にCDNから動的ロード
2. **静的ビルド**: Next.jsで静的HTMLを事前生成
3. **画像の最適化**: 処理後の画像はDataURLで保持

## エラーハンドリング

### ユーザーフレンドリーなメッセージ

```typescript
// 悪い例
alert('Error: Image processing failed')

// 良い例
alert('😅 うまくいかなかったみたい。もう一度写真をとってみてね！')
```

### エラーケース

1. **OpenCV.jsロード失敗**
   - ボタンを無効化
   - 「じゅんび中...」と表示

2. **紙の検出失敗**
   - 調整UIをスキップ
   - 元画像のまま処理続行

3. **画像処理エラー**
   - 優しいメッセージで再試行を促す
   - 初期状態に戻る

## テスト戦略

### 手動テストチェックリスト

#### 基本機能

- [ ] カメラで撮影できる
- [ ] ファイルから画像を選択できる
- [ ] OpenCV.jsが正常にロードされる

#### 紙の検出

- [ ] 正面から撮った紙を検出できる
- [ ] 斜めから撮った紙を検出できる
- [ ] 背景が複雑でも検出できる
- [ ] 検出失敗時も処理を続行できる

#### 角の調整

- [ ] 4つの角が正しく表示される
- [ ] マウスでドラッグできる
- [ ] タッチでドラッグできる（スマホ）
- [ ] 画像境界外に出ない
- [ ] ドラッグ中の角が光る

#### 画像処理

- [ ] 台形補正が正しく動作する
- [ ] 色調補正が適用される
- [ ] 左右に正しく分割される

#### 画像比較

- [ ] タップで右の画像が表示される
- [ ] 離すと左の画像に戻る
- [ ] マウス操作でも動作する
- [ ] アニメーションがスムーズ

#### デバイス対応

- [ ] iOS Safari で動作する
- [ ] Android Chrome で動作する
- [ ] PCブラウザで動作する
- [ ] 縦向き・横向き両対応

## セキュリティ

### プライバシー保護

1. **画像の外部送信なし**: すべてブラウザ内で処理
2. **ローカルストレージ不使用**: 画像をメモリにのみ保持
3. **外部API不使用**: OpenCV.jsのみCDNから取得

### セキュアなホスティング

1. **HTTPS必須**: カメラアクセスに必要
2. **静的サイト**: サーバーサイドの脆弱性なし
3. **依存関係の定期更新**: `npm audit`で脆弱性チェック

## 今後の拡張可能性

### 実装済み

- ✅ 紙の自動検出
- ✅ 台形補正
- ✅ 角の手動調整
- ✅ 色調補正
- ✅ 左右分割
- ✅ タップで比較

### 今後の候補

- 差分の自動検出
- PWA化（オフライン対応）
- 画像の保存機能
- SNSシェア機能
- 複数の間違い探しを管理
